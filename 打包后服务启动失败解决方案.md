# æ‰“åŒ…åæœåŠ¡å¯åŠ¨å¤±è´¥åŠæ—¥å¿—ä¹±ç é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°
1. ä½¿ç”¨æ–¹æ¡ˆäºŒæ‰“åŒ…åçš„exeè¿è¡Œåï¼Œç‚¹å‡»æœåŠ¡ç®¡ç†çš„å¯åŠ¨æŒ‰é’®ï¼ŒæœåŠ¡å¹¶æ²¡æœ‰å¯åŠ¨æˆåŠŸã€‚
2. è¿è¡Œæ‰“åŒ…ç¨‹åºåï¼ŒGUIç•Œé¢æ˜¾ç¤ºçš„æ—¥å¿—å‡ºç°ä¹±ç ã€‚

## é—®é¢˜åŸå› 

### 1. ä¸»è¦åŸå› 
åœ¨æ‰“åŒ…åçš„ç¯å¢ƒä¸­ï¼Œ`main.py` ä½œä¸ºç»Ÿä¸€å…¥å£ç‚¹ï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥å†³å®šè¿è¡Œå“ªä¸ªæ¨¡å—ã€‚ä½†æ˜¯ï¼š

- `api_server.py` çš„ä¸»è¦æ‰§è¡Œä»£ç åœ¨ `if __name__ == "__main__":` å—ä¸­
- å½“é€šè¿‡ `import api_server` å¯¼å…¥æ—¶ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¸ä¼šæ‰§è¡Œ
- `main.py` ä¸­åªæ˜¯ç®€å•åœ°å¯¼å…¥æ¨¡å—ï¼Œå¦‚æœæ¨¡å—æ²¡æœ‰ `main()` å‡½æ•°ï¼Œå°±åªä¼šæ‰“å°ä¸€æ¡æ¶ˆæ¯ç„¶åé€€å‡º

### 2. ä»£ç åˆ†æ

#### main.py ä¸­çš„é—®é¢˜ä»£ç ï¼š
```python
if module_name == "api_server":
    try:
        import api_server
        if hasattr(api_server, 'main'):
            api_server.main()
        else:
            # å¦‚æœ api_server.py æ²¡æœ‰ main å‡½æ•°ï¼Œç›´æ¥å¯¼å…¥æ‰§è¡Œ
            print("API Server starting...")  # åªæ‰“å°è¿™æ¡æ¶ˆæ¯ï¼Œç„¶åä»€ä¹ˆéƒ½ä¸åš
```

#### api_server.py ä¸­çš„é—®é¢˜ï¼š
```python
if __name__ == "__main__":
    # è¿™éƒ¨åˆ†ä»£ç åªæœ‰ç›´æ¥è¿è¡Œ api_server.py æ—¶æ‰ä¼šæ‰§è¡Œ
    api_port = 5102
    logger.info(f"ğŸš€ LMArena Bridge v2.0 API æœåŠ¡å™¨æ­£åœ¨å¯åŠ¨...")
    uvicorn.run(app, host="127.0.0.1", port=api_port)
```

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹ api_server.py
æ·»åŠ ä¸€ä¸ª `main()` å‡½æ•°ï¼Œå°†åŸæ¥åœ¨ `if __name__ == "__main__":` ä¸­çš„ä»£ç ç§»åˆ°è¿™ä¸ªå‡½æ•°ä¸­ï¼š

```python
def main():
    """APIæœåŠ¡å™¨ä¸»å‡½æ•°"""
    api_port = 5102
    logger.info(f"ğŸš€ LMArena Bridge v2.0 API æœåŠ¡å™¨æ­£åœ¨å¯åŠ¨...")
    logger.info(f"   - ç›‘å¬åœ°å€: http://127.0.0.1:{api_port}")
    logger.info(f"   - WebSocket ç«¯ç‚¹: ws://127.0.0.1:{api_port}/ws")
    
    uvicorn.run(app, host="127.0.0.1", port=api_port)

if __name__ == "__main__":
    main()
```

### 2. ä¿®æ”¹ id_updater.py
åŒæ ·çš„é—®é¢˜ä¹Ÿå­˜åœ¨äº `id_updater.py`ï¼Œéœ€è¦æ·»åŠ  `main()` å‡½æ•°ï¼š

```python
def main():
    """IDæ›´æ–°å™¨ä¸»å‡½æ•°"""
    # åŸæ¥åœ¨ if __name__ == "__main__": ä¸­çš„æ‰€æœ‰ä»£ç 
    config = read_config()
    if not config:
        exit(1)
    # ... å…¶ä½™ä»£ç  ...

if __name__ == "__main__":
    main()
```

## å·²å®æ–½çš„ä¿®æ”¹

1. **api_server.py**ï¼š
   - æ·»åŠ äº† `main()` å‡½æ•°
   - å°†åŸæ¥åœ¨ `if __name__ == "__main__":` ä¸­çš„ä»£ç ç§»åˆ° `main()` å‡½æ•°ä¸­

2. **id_updater.py**ï¼š
   - æ·»åŠ äº† `main()` å‡½æ•°
   - å°†åŸæ¥åœ¨ `if __name__ == "__main__":` ä¸­çš„ä»£ç ç§»åˆ° `main()` å‡½æ•°ä¸­

## æµ‹è¯•æ­¥éª¤

1. é‡æ–°è¿è¡Œæ‰“åŒ…è„šæœ¬ï¼š
   ```bash
   python final_pack_v2.py
   ```

2. è¿è¡Œç”Ÿæˆçš„ `LMArenaBridge.exe`

3. æµ‹è¯•åŠŸèƒ½ï¼š
   - ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®å¯åŠ¨APIæœåŠ¡å™¨
   - æ£€æŸ¥æœåŠ¡æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æœåŠ¡å™¨å¯åŠ¨ä¿¡æ¯
   - æµ‹è¯•"æ›´æ–°ä¼šè¯ID"åŠŸèƒ½

## GUIæ—¥å¿—ä¹±ç é—®é¢˜

### é—®é¢˜åŸå› 
åœ¨Windowsæ‰“åŒ…ç¯å¢ƒä¸­ï¼Œå­è¿›ç¨‹çš„è¾“å‡ºç¼–ç å¯èƒ½ä¸GUIæœŸæœ›çš„ç¼–ç ä¸ä¸€è‡´ï¼Œå¯¼è‡´ä¸­æ–‡ç­‰éASCIIå­—ç¬¦æ˜¾ç¤ºä¸ºä¹±ç ã€‚

### è§£å†³æ–¹æ¡ˆ

1. **è®¾ç½®ç¯å¢ƒå˜é‡**ï¼š
   ```python
   env = os.environ.copy()
   env["PYTHONUTF8"] = "1"
   env["PYTHONIOENCODING"] = "utf-8"
   ```

2. **éšè—æ§åˆ¶å°çª—å£**ï¼ˆWindowsç‰¹æœ‰ï¼‰ï¼š
   ```python
   startupinfo = None
   if sys.platform == "win32":
       startupinfo = subprocess.STARTUPINFO()
       startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW
       startupinfo.wShowWindow = subprocess.SW_HIDE
   ```

3. **æ”¹è¿›æ—¥å¿—ç›‘æ§æ–¹æ³•**ï¼š
   ```python
   def monitor_api_server_output(self):
       """ç›‘æ§APIæœåŠ¡å™¨è¾“å‡º"""
       if not self.api_server_process:
           return
           
       try:
           for line in iter(self.api_server_process.stdout.readline, ''):
               if line:
                   # ç¡®ä¿lineæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå¤„ç†å¯èƒ½çš„ç¼–ç é—®é¢˜
                   if isinstance(line, bytes):
                       line = line.decode('utf-8', errors='replace')
                   # ç§»é™¤ç‰¹æ®Šå­—ç¬¦å’Œæ§åˆ¶å­—ç¬¦
                   line = line.strip()
                   # è¿‡æ»¤æ‰ç©ºè¡Œ
                   if line:
                       # ä½¿ç”¨å®‰å…¨çš„æ–¹å¼ä¼ é€’æ—¥å¿—æ¶ˆæ¯
                       self.root.after(0, self.log_message, f"[API] {line}")
               if self.api_server_process.poll() is not None:
                   break
       except Exception as e:
           self.root.after(0, lambda: self.log_message(f"[API] ç›‘æ§è¾“å‡ºæ—¶å‡ºé”™: {e}", "ERROR"))
   ```

## æ·±å±‚ç¼–ç é—®é¢˜çš„æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

ç”±äºWindowsç³»ç»Ÿé»˜è®¤ä½¿ç”¨GBKç¼–ç ï¼Œå³ä½¿è®¾ç½®äº†ç¯å¢ƒå˜é‡ï¼ŒæŸäº›æƒ…å†µä¸‹ä»ç„¶ä¼šå‡ºç°ç¼–ç é—®é¢˜ã€‚æœ€ç»ˆè§£å†³æ–¹æ¡ˆæ˜¯åˆ›å»ºä¸€ä¸ªç¼–ç ä¿®å¤è„šæœ¬ä½œä¸ºç¨‹åºå…¥å£ã€‚

### 1. åˆ›å»º encoding_fix.py
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç¼–ç ä¿®å¤è„šæœ¬
ç”¨äºè§£å†³Windowsç¯å¢ƒä¸‹çš„ç¼–ç é—®é¢˜
"""

import sys
import os
import locale
import codecs

def fix_encoding():
    """ä¿®å¤Pythonç¯å¢ƒçš„ç¼–ç é—®é¢˜"""
    # å¼ºåˆ¶è®¾ç½®UTF-8ç¼–ç 
    if sys.platform == "win32":
        # è®¾ç½®ç¯å¢ƒå˜é‡
        os.environ["PYTHONUTF8"] = "1"
        os.environ["PYTHONIOENCODING"] = "utf-8"
        
        # å°è¯•è®¾ç½®æ§åˆ¶å°ä»£ç é¡µä¸ºUTF-8
        try:
            import ctypes
            kernel32 = ctypes.windll.kernel32
            # è®¾ç½®æ§åˆ¶å°è¾“å‡ºä»£ç é¡µä¸ºUTF-8
            kernel32.SetConsoleOutputCP(65001)
            # è®¾ç½®æ§åˆ¶å°è¾“å…¥ä»£ç é¡µä¸ºUTF-8
            kernel32.SetConsoleCP(65001)
        except:
            pass
        
        # é‡å®šå‘æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡º
        if hasattr(sys.stdout, 'buffer'):
            sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
        if hasattr(sys.stderr, 'buffer'):
            sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')

# åœ¨å¯¼å…¥å…¶ä»–æ¨¡å—ä¹‹å‰ä¿®å¤ç¼–ç 
fix_encoding()

# ç°åœ¨å¯¼å…¥å¹¶è¿è¡Œä¸»ç¨‹åº
if __name__ == "__main__":
    import main
    main.main()
```

### 2. ä¿®æ”¹æ‰“åŒ…è„šæœ¬
åœ¨ `final_pack_v2.py` ä¸­ï¼Œå°†å…¥å£æ–‡ä»¶æ”¹ä¸º `encoding_fix.py`ï¼š
```python
# ä¸»å…¥å£æ–‡ä»¶
"encoding_fix.py"  # ä½¿ç”¨ç¼–ç ä¿®å¤è„šæœ¬ä½œä¸ºå…¥å£
```

### 3. é‡æ–°æ‰“åŒ…
```bash
python final_pack_v2.py
```

## æ€»ç»“

è¿™äº›é—®é¢˜éƒ½æ˜¯Pythonæ‰“åŒ…æ—¶çš„å¸¸è§é—®é¢˜ï¼š

1. **æœåŠ¡å¯åŠ¨å¤±è´¥**ï¼šç”±äºPythonæ¨¡å—çš„å¯¼å…¥æœºåˆ¶ï¼Œ`if __name__ == "__main__":` å—ä¸­çš„ä»£ç åœ¨è¢«å¯¼å…¥æ—¶ä¸ä¼šæ‰§è¡Œã€‚
   - è§£å†³æ–¹æ¡ˆï¼šä¸ºæ‰€æœ‰æ¨¡å—æ·»åŠ  `main()` å‡½æ•°

2. **æ—¥å¿—ä¹±ç **ï¼šWindowsç¯å¢ƒä¸‹å­è¿›ç¨‹è¾“å‡ºç¼–ç ä¸GUIç¼–ç ä¸ä¸€è‡´å¯¼è‡´ã€‚
   - è§£å†³æ–¹æ¡ˆï¼šåˆ›å»ºç¼–ç ä¿®å¤è„šæœ¬ä½œä¸ºç¨‹åºå…¥å£ï¼Œåœ¨å¯¼å…¥ä»»ä½•æ¨¡å—ä¹‹å‰è®¾ç½®æ­£ç¡®çš„ç¼–ç ç¯å¢ƒ

é€šè¿‡åˆç†çš„ä»£ç é‡æ„å’Œç¼–ç å¤„ç†ï¼Œè¿™äº›é—®é¢˜éƒ½å¯ä»¥å¾—åˆ°æœ‰æ•ˆè§£å†³ã€‚ç¼–ç ä¿®å¤è„šæœ¬ç¡®ä¿äº†æ•´ä¸ªç¨‹åºè¿è¡Œç¯å¢ƒéƒ½ä½¿ç”¨UTF-8ç¼–ç ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†ä¹±ç é—®é¢˜ã€‚
